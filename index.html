<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mine Risk Map — Kharkiv Oblast</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- TimeDimension (css+js) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.control.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.min.js"></script>

  <!-- Heatmap -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100vh; }
    .legend { background:#fff; padding:8px 10px; border-radius:6px; line-height:1.4; box-shadow:0 1px 4px rgba(0,0,0,.2); }
    .legend i { width:14px; height:14px; display:inline-block; margin-right:6px; opacity:.85; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
/* ---------------- 1) MAP CORE ---------------- */
const supportsTD = typeof L.TimeDimension !== 'undefined';
const map = L.map('map', supportsTD ? {
  zoomControl: true,
  timeDimension: true,
  timeDimensionControl: true,
  timeDimensionOptions: { timeInterval: "2022-06-01/2026-12-31", period: "P1M" }
} : { zoomControl:true }).setView([49.9935, 36.2304], 8);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const baseLayers = { 'OpenStreetMap': osm };

/* ---------------- 2) CHOROPLETH ---------------- */
function color(v){
  return v > 5000 ? '#800026' :
         v > 1000 ? '#BD0026' :
         v > 500  ? '#E31A1C' :
         v > 100  ? '#FC4E2A' :
         v > 50   ? '#FD8D3C' :
         v > 10   ? '#FEB24C' : '#FFEDA0';
}
const choroplethLayer = L.layerGroup().addTo(map);
fetch('data/admin_agg.geojson').then(r=>r.json()).then(geo=>{
  const layer = L.geoJSON(geo, {
    style: f => ({ weight:1, color:'#999', fillOpacity:.7, fillColor: color((f.properties?.sum_participants)||0) }),
    onEachFeature: (f,l)=>{
      const p=f.properties||{};
      l.bindPopup(`<b>${p.hromada||'Громада'}</b><br>Осіб за період: ${p.sum_participants??0}`);
      l.on('mouseover', ()=>l.setStyle({weight:2,color:'#555'}));
      l.on('mouseout', ()=>l.setStyle({weight:1,color:'#999'}));
    }
  });
  choroplethLayer.addLayer(layer);
}).catch(console.error);

/* ---------------- 3) POINTS: cluster + timedimension + heat ---------------- */
const clusterLayer = L.markerClusterGroup();
const timePointsGroup = L.layerGroup();
let heatLayer = null;

fetch('data/sessions.geojson').then(r=>r.json()).then(geo=>{
  // markers (cluster)
  const markers = L.geoJSON(geo, {
    pointToLayer: (f,latlng)=>L.marker(latlng),
    onEachFeature: (f,layer)=>{
      const p=f.properties||{};
      layer.bindPopup(
        `<b>${p.datetime||'—'}</b><br>${p.hromada||''}${p.rayon?', '+p.rayon:''}<br>`+
        `Аудиторія: ${p.audience||'—'}<br>Інструктор: ${p.instructor||'—'}<br>Осіб: ${p.participants??'—'}`
      );
    }
  });
  clusterLayer.addLayer(markers);

  // time layer (only if plugin loaded)
  if (supportsTD) {
    geo.features.forEach(f=>{ if(f.properties) f.properties.time = f.properties.datetime; });
    const timeGeo = L.geoJSON(geo, { pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:6,color:'#0a84ff',fillColor:'#0a84ff',fillOpacity:.8}) });
    const td = L.timeDimension.layer.geoJson(timeGeo, { updateTimeDimension:true, addlastPoint:false, duration:'P15D', waitForReady:true });
    timePointsGroup.addLayer(td);
  }

  // heat (only if plugin loaded)
  if (typeof L.heatLayer !== 'undefined') {
    const heatData = geo.features.map(f=>{
      const c=f.geometry?.coordinates, p=f.properties||{};
      if(!c) return null;
      const intensity = Math.min(1, (p.participants||1)/100);
      return [c[1], c[0], intensity];
    }).filter(Boolean);
    heatLayer = L.heatLayer(heatData, { radius:25, blur:15, maxZoom:12 });
  }
}).catch(console.error);

/* ---------------- 4) LAYERS CONTROL ---------------- */
const overlays = { 'Кластер точок': clusterLayer, 'Хороплет громад': choroplethLayer };
if (supportsTD) overlays['Точки у часі (Time slider)'] = timePointsGroup;
// lazy proxy for heat
if (typeof L.heatLayer !== 'undefined') {
  const proxy = L.layerGroup();
  proxy.on('add', ()=>{ heatLayer && heatLayer.addTo(map); });
  proxy.on('remove', ()=>{ heatLayer && map.removeLayer(heatLayer); });
  overlays['Heatmap (щільність)'] = proxy;
}
L.control.layers(baseLayers, overlays, {collapsed:false}).addTo(map);

// default on:
map.addLayer(clusterLayer);
map.addLayer(choroplethLayer);

/* ---------------- 5) LEGEND ---------------- */
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  const grades=[0,10,50,100,500,1000,5000];
  div.innerHTML+='<b>Осіб за період</b><br>';
  for(let i=0;i<grades.length;i++){
    const from=grades[i], to=grades[i+1], c=color(from+0.1);
    div.innerHTML += `<i style="background:${c}"></i> ${from}${to?'&ndash;'+to:'+'}<br>`;
  }
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
